<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submarinos Museos del Mundo</title>
    
    <!-- CSS de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- CSS para la agrupación de marcadores (MarkerCluster) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- CSS para DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
     
    <!-- Estilos CSS para el layout y la tabla -->
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 60vh; background-color: #f0f0f0; }
        #table-container { height: 40vh; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; background-color: #f8f9fa; }
        #filters { padding-bottom: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #filters label { font-weight: bold; }
        #filters select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .dataTables_wrapper { flex-grow: 1; overflow-y: auto; }
        table.dataTable tbody tr.selected { background-color: #b0d4f1 !important; }
        .popup-content h3 { margin: 0 0 5px 0; font-size: 16px; }
        .popup-content { text-align: left; font-size: 14px; line-height: 1.4; }
        .popup-image { max-width: 180px; height: auto; border-radius: 5px; margin-top: 5px; }
        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        #loader-content { font-size: 1.5em; }
        #loader-error { font-size: 1em; color: #c0392b; max-width: 600px; }
    </style>
</head>
<body>

<div id="loader">
    <div id="loader-content">Cargando datos de submarinos...</div>
</div>

<!-- Contenedor del mapa -->
<div id="map"></div>

<!-- Contenedor para la tabla y filtros -->
<div id="table-container">
    <div id="filters">
        <label for="type-filter">Filtrar por Tipo:</label>
        <select id="type-filter"><option value="">Todos</option></select>
        <label for="country-filter">Filtrar por País:</label>
        <select id="country-filter"><option value="">Todos</option></select>
    </div>
    <table id="submarines-table" class="display" width="100%"></table>
</div>

<!-- Librerías de JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    // URL de tu hoja de Google Sheet publicada como CSV
    const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTuLWdJ1ZNR9dQ9sHcDOWe1-HPnIMsAKtCRzVEG_WZG4Za_3Mp-X3vkWCFlSwuNQSfEZ_mmNmTcIgb/pub?gid=164271551&single=true&output=csv';

    const loader = document.getElementById('loader');
    const loaderContent = document.getElementById('loader-content');
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri', maxZoom: 19
    }).addTo(map);

    const defaultSubmarineIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUgMTJIN2E1IDUgMCAwMC01IDV2MWE1IDUgMCAwMDQgNC41VjIxaDJ2LTEuNWExLjUgMS41IDAgMDEzIDBWMjFoMmwxLjM4LTEuODYuMDEuMDEuMDEtLjAxYTUgNSAwIDAwMy42LTYuNUwyMiA5bC0zIDMiLz48cGF0aCBkPSJNMTggMTBIMTBWOGgydjEuNUwMTggMTBaIi8+PC9zdmc+',
        iconSize: [38, 38], iconAnchor: [19, 19], popupAnchor: [0, -20]
    });

    let table;
    const markers = L.markerClusterGroup();
    const allMarkers = {};
    let puntosDeInteres = [];

    // Función que envuelve una URL en un proxy CORS si es de un dominio externo
    function getProxiedUrl(url) {
        if (url && url.startsWith('http')) {
            return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        }
        return url; // Devuelve la URL original si no es válida o no necesita proxy
    }

    function initializeApp(data) {
        puntosDeInteres = data;
        map.addLayer(markers);
        setupMarkers();
        setupTable();
        setupFilters();
        setupTableClickHandler();
        loader.style.display = 'none';
    }

    function setupMarkers() {
        puntosDeInteres.forEach(punto => {
            let finalIcon = defaultSubmarineIcon;

            // **CORRECCIÓN: Aplicar proxy al ícono del marcador**
            if (punto.markerIconUrl) {
                finalIcon = L.icon({
                    iconUrl: getProxiedUrl(punto.markerIconUrl),
                    iconSize: [38, 38],
                    iconAnchor: [19, 38],
                    popupAnchor: [0, -40],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    shadowSize: [41, 41],
                    shadowAnchor: [12, 41]
                });
            }
            
            // **CORRECCIÓN: Aplicar proxy a la imagen del popup**
            const proxiedPopupImageUrl = getProxiedUrl(punto.imagen);

            const popupContent = `<div class="popup-content"><h3>${punto.nombre}</h3><p>${punto.descripcion || ''}</p><img src="${proxiedPopupImageUrl}" class="popup-image" onerror="this.style.display='none'"></div>`;
            const marker = L.marker([punto.lat, punto.lng], { icon: finalIcon }).bindPopup(popupContent);
            marker.pointId = punto.id;
            allMarkers[punto.id] = marker;
            markers.addLayer(marker);
        });
    }

    function setupTable() {
        table = $('#submarines-table').DataTable({
            data: puntosDeInteres,
            columns: [
                { data: 'nombre', title: 'Nombre' },
                { data: 'tipo', title: 'Tipo' },
                { data: 'pais', title: 'País' },
                { data: 'location', title: 'Ubicación' }
            ],
            scrollY: "calc(40vh - 100px)",
            scrollCollapse: true,
            paging: false,
            info: false,
            language: { search: "Buscar:" }
        });
    }
    
    function setupFilters() {
        const typeFilter = $('#type-filter');
        const countryFilter = $('#country-filter');
        const types = [...new Set(puntosDeInteres.map(p => p.tipo).filter(Boolean))];
        const countries = [...new Set(puntosDeInteres.map(p => p.pais).filter(Boolean))];
        types.sort().forEach(type => typeFilter.append(`<option value="${type}">${type}</option>`));
        countries.sort().forEach(country => countryFilter.append(`<option value="${country}">${country}</option>`));

        typeFilter.on('change', applyFilters);
        countryFilter.on('change', applyFilters);
    }

    function applyFilters() {
        const selectedType = $('#type-filter').val();
        const selectedCountry = $('#country-filter').val();

        $.fn.dataTable.ext.search.pop();
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const punto = puntosDeInteres[dataIndex];
            const typeMatch = (selectedType === "" || punto.tipo === selectedType);
            const countryMatch = (selectedCountry === "" || punto.pais === selectedCountry);
            return typeMatch && countryMatch;
        });
        table.draw();
        
        markers.clearLayers();
        const filteredData = table.rows({ search: 'applied' }).data().toArray();
        const filteredIds = new Set(filteredData.map(d => d.id));
        
        puntosDeInteres.forEach(punto => {
            if (filteredIds.has(punto.id)) {
                markers.addLayer(allMarkers[punto.id]);
            }
        });
    }

    function setupTableClickHandler() {
        $('#submarines-table tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            } else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
            
            const data = table.row(this).data();
            if(data) {
                const marker = allMarkers[data.id];
                map.flyTo([data.lat, data.lng], 15);
                if (markers.hasLayer(marker)) {
                     markers.zoomToShowLayer(marker, () => marker.openPopup());
                }
            }
        });
    }

    Papa.parse(googleSheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: header => header.trim(),
        complete: function(results) {
            if (results.errors.length > 0) {
                console.error("Errores de Parseo:", results.errors);
                loaderContent.innerHTML = `<div id="loader-error"><h3>Error al procesar los datos</h3><p>Se encontraron errores en el archivo CSV. Revisa la consola del navegador (F12) para más detalles y verifica la fila indicada en tu hoja de cálculo.</p><p>Primer error: ${results.errors[0].message} en la fila ${results.errors[0].row + 2}</p></div>`;
                return;
            }

            const processedData = results.data.map((row, index) => ({
                id: row.id || index,
                lat: parseFloat(row.Latitude),
                lng: parseFloat(row.Longitude),
                nombre: row.Name,
                tipo: row.Group,
                pais: row.Country,
                location: row.Location,
                descripcion: row.Description,
                imagen: row.Image,
                markerIconUrl: row['Marker Icon']
            })).filter(p => p.nombre && !isNaN(p.lat) && !isNaN(p.lng));

            if (processedData.length === 0) {
                 loaderContent.innerHTML = `<div id="loader-error"><h3>No se encontraron datos</h3><p>El archivo CSV se cargó pero no contiene filas con datos válidos (Nombre, Latitud, Longitud). Revisa tu hoja de cálculo.</p></div>`;
                 return;
            }

            initializeApp(processedData);
        },
        error: function(error) {
            console.error("Error al cargar el archivo CSV:", error);
            loaderContent.innerHTML = `<div id="loader-error"><h3>Error Crítico al Cargar Datos</h3><p>No se pudo descargar la información desde la URL proporcionada.</p><p><strong>Causa Posible:</strong> La URL es incorrecta, la hoja no está publicada como CSV para acceso público, o hay un problema de red.</p></div>`;
        }
    });
</script>

</body>
</html>
